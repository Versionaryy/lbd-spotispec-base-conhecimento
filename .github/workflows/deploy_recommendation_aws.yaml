name: Deploy backend na AWS


on:
  push:
    branches:
      - main

env:
  CFN_STACK_NAME: api-lambda-reco  
  CFN_TEMPLATE_FILE: infra/deploy_lambda.yaml
  ECR_REPO: api-lambda-musica-base-conhecimento
  IMAGE_TAG: ${{ github.sha }}
  LAMBDA_NAME: lbd-spotispec-base-conhecimento
  API_GATEWAY_ID: ${{ secrets.API_GATEWAY_ID }}
  
jobs: 
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Criar repositório ECR (se não existir)
        run: |
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPO }} --region ${{ secrets.AWS_REGION }} || aws ecr create-repository --repository-name ${{ env.ECR_REPO }} --region ${{ secrets.AWS_REGION }}

      - name: Deletar stack em ROLLBACK_COMPLETE (se existir)
        run: |
          STATUS=$(aws cloudformation describe-stacks --stack-name ${{ env.LAMBDA_NAME }} --region ${{ secrets.AWS_REGION }} --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "")
          if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
            echo "Stack em ROLLBACK_COMPLETE, deletando..."
            aws cloudformation delete-stack --stack-name ${{ env.LAMBDA_NAME }} --region ${{ secrets.AWS_REGION }}
            aws cloudformation wait stack-delete-complete --stack-name ${{ env.LAMBDA_NAME }} --region ${{ secrets.AWS_REGION }}
            echo "Stack deletado com sucesso"
          else
            echo "Stack status: $STATUS (nenhuma ação necessária)"
          fi

      - name: Login no ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      - name: Build da imagem Docker
        run: |
          docker build -t ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }} .

      - name: Push da imagem para ECR
        run: |
          docker tag ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }} ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}

      - name: Comando CLI para executar Cloudformation
        run: |
- name: Comando CLI para executar Cloudformation
        run: |
          aws cloudformation deploy \
            --template-file ${{ env.CFN_TEMPLATE_FILE }} \
            --stack-name ${{ env.LAMBDA_NAME }} \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              EcrRepositoryName=${{ env.ECR_REPO }} \
              ImageTag=${{ env.IMAGE_TAG }} \
              LambdaName=${{ env.LAMBDA_NAME }} \
              ApiGatewayId=${{ env.API_GATEWAY_ID }} \
              SpotifyClientId=${{ secrets.SPOTIFY_CLIENT_ID }} \
              SpotifyClientSecret=${{ secrets.SPOTIFY_CLIENT_SECRET }} \
              --debug
